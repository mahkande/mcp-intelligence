"""
AI-powered features for Pylance MCP Pro
Requires ANTHROPIC_API_KEY in environment
"""

import os
from typing import Dict, List, Any
from anthropic import Anthropic

client = Anthropic(api_key=os.getenv('ANTHROPIC_API_KEY'))

async def explain_type_error(
    code: str,
    error_message: str,
    file_path: str,
    line_number: int
) -> Dict[str, Any]:
    """
    Use Claude to explain a type error in simple terms with fix suggestions
    
    Args:
        code: The code snippet containing the error
        error_message: The raw Pyright error message
        file_path: Path to the file with the error
        line_number: Line number where error occurs
    
    Returns:
        Dict with explanation, causes, and suggested fixes
    """
    
    prompt = f"""You are a Python type error expert. A developer has encountered this type error:

File: {file_path}
Line: {line_number}
Error: {error_message}

Code snippet:
```python
{code}
```

Please provide:
1. A clear, beginner-friendly explanation of what this error means
2. Why it occurred (root causes)
3. 2-3 concrete code fixes with examples
4. Best practices to avoid this error in the future

Be concise and practical. Focus on actionable solutions."""

    try:
        message = client.messages.create(
            model="claude-sonnet-4-20250514",
            max_tokens=1500,
            messages=[{
                "role": "user",
                "content": prompt
            }]
        )
        
        explanation = message.content[0].text
        
        return {
            "success": True,
            "explanation": explanation,
            "model": "claude-sonnet-4",
            "tokens_used": message.usage.input_tokens + message.usage.output_tokens
        }
        
    except Exception as e:
        return {
            "success": False,
            "error": str(e)
        }


async def enhance_type_annotations(
    code: str,
    file_path: str,
    existing_types: List[Dict[str, Any]]
) -> Dict[str, Any]:
    """
    Use Claude to suggest improved type annotations for code
    
    Args:
        code: The code to analyze
        file_path: Path to the file
        existing_types: Existing type information from Pyright
    
    Returns:
        Dict with suggested type improvements
    """
    
    # Format existing types
    types_context = "\n".join([
        f"- {t.get('symbol', 'unknown')}: {t.get('type', 'unknown')}"
        for t in existing_types[:10]  # Limit to avoid token bloat
    ])
    
    prompt = f"""You are a Python typing expert. Analyze this code and suggest improved type annotations.

File: {file_path}

Current types detected:
{types_context}

Code:
```python
{code}
```

Please suggest:
1. Missing type annotations that should be added
2. Generic types that could be more specific
3. Union types that could be simplified
4. Return type annotations for functions
5. Type aliases that would improve readability

For each suggestion, provide:
- Line number
- Current code
- Suggested improvement
- Reasoning

Format as JSON array of suggestions."""

    try:
        message = client.messages.create(
            model="claude-sonnet-4-20250514",
            max_tokens=2000,
            messages=[{
                "role": "user",
                "content": prompt
            }]
        )
        
        suggestions = message.content[0].text
        
        return {
            "success": True,
            "suggestions": suggestions,
            "model": "claude-sonnet-4",
            "tokens_used": message.usage.input_tokens + message.usage.output_tokens
        }
        
    except Exception as e:
        return {
            "success": False,
            "error": str(e)
        }


async def analyze_code_patterns(
    code: str,
    diagnostics: List[Dict[str, Any]]
) -> Dict[str, Any]:
    """
    Use Claude to identify code patterns and suggest improvements
    
    Args:
        code: The code to analyze
        diagnostics: Existing diagnostics from Pyright
    
    Returns:
        Dict with pattern analysis and suggestions
    """
    
    # Format diagnostics
    diag_summary = "\n".join([
        f"- Line {d.get('line', '?')}: {d.get('message', 'unknown')}"
        for d in diagnostics[:5]
    ])
    
    prompt = f"""Analyze this Python code for patterns and improvements.

Existing issues:
{diag_summary}

Code:
```python
{code}
```

Identify:
1. Anti-patterns or code smells
2. Type safety issues
3. Opportunities for better abstractions
4. Performance considerations
5. Maintainability improvements

Prioritize suggestions by impact. Be specific and actionable."""

    try:
        message = client.messages.create(
            model="claude-sonnet-4-20250514",
            max_tokens=1500,
            messages=[{
                "role": "user",
                "content": prompt
            }]
        )
        
        analysis = message.content[0].text
        
        return {
            "success": True,
            "analysis": analysis,
            "model": "claude-sonnet-4",
            "tokens_used": message.usage.input_tokens + message.usage.output_tokens
        }
        
    except Exception as e:
        return {
            "success": False,
            "error": str(e)
        }


async def suggest_type_stubs(
    library_name: str,
    usage_examples: List[str]
) -> Dict[str, Any]:
    """
    Generate type stub suggestions for untyped libraries
    
    Args:
        library_name: Name of the library
        usage_examples: Code examples showing library usage
    
    Returns:
        Dict with stub file suggestions
    """
    
    examples = "\n\n".join(usage_examples[:3])
    
    prompt = f"""Generate type stub (.pyi) suggestions for the library '{library_name}'.

Usage examples:
```python
{examples}
```

Create a type stub file that includes:
1. Function signatures with proper types
2. Class definitions with methods
3. Constants and module-level variables
4. Docstrings for complex types

Format as a complete .pyi file."""

    try:
        message = client.messages.create(
            model="claude-sonnet-4-20250514",
            max_tokens=2000,
            messages=[{
                "role": "user",
                "content": prompt
            }]
        )
        
        stub_content = message.content[0].text
        
        return {
            "success": True,
            "stub_content": stub_content,
            "library": library_name,
            "model": "claude-sonnet-4",
            "tokens_used": message.usage.input_tokens + message.usage.output_tokens
        }
        
    except Exception as e:
        return {
            "success": False,
            "error": str(e)
        }
