"""
OpenTelemetry Tracing Configuration

Sets up distributed tracing for the Pylance MCP Server using OpenTelemetry.
Sends traces to AI Toolkit's local OTLP collector.
"""

import logging
from typing import Optional
from opentelemetry import trace
from opentelemetry.sdk.trace import TracerProvider
from opentelemetry.sdk.trace.export import BatchSpanProcessor
from opentelemetry.exporter.otlp.proto.http.trace_exporter import OTLPSpanExporter
from opentelemetry.sdk.resources import Resource

logger = logging.getLogger(__name__)

_tracer: Optional[trace.Tracer] = None


def setup_tracing(service_name: str = "pylance-mcp-server", otlp_endpoint: str = "http://localhost:4318") -> trace.Tracer:
    """
    Initialize OpenTelemetry tracing with OTLP exporter.
    
    Args:
        service_name: Name of the service for trace identification
        otlp_endpoint: OTLP HTTP endpoint (default: AI Toolkit's localhost endpoint)
        
    Returns:
        Configured tracer instance
    """
    global _tracer
    
    if _tracer is not None:
        logger.info("Tracing already initialized")
        return _tracer
    
    try:
        # Create resource with service information
        resource = Resource.create({
            "service.name": service_name,
            "service.version": "1.0.0",
        })
        
        # Set up the tracer provider
        provider = TracerProvider(resource=resource)
        
        # Configure OTLP exporter for AI Toolkit
        otlp_exporter = OTLPSpanExporter(
            endpoint=f"{otlp_endpoint}/v1/traces",
            timeout=5,
        )
        
        # Add span processor
        span_processor = BatchSpanProcessor(otlp_exporter)
        provider.add_span_processor(span_processor)
        
        # Set as global tracer provider
        trace.set_tracer_provider(provider)
        
        # Get tracer instance
        _tracer = trace.get_tracer(__name__)
        
        logger.info(f"OpenTelemetry tracing initialized: {service_name} -> {otlp_endpoint}")
        return _tracer
        
    except Exception as e:
        logger.error(f"Failed to initialize tracing: {e}")
        # Return no-op tracer on failure
        _tracer = trace.get_tracer(__name__)
        return _tracer


def get_tracer() -> trace.Tracer:
    """
    Get the configured tracer instance.
    
    Returns:
        Tracer instance (initializes with defaults if not already set up)
    """
    global _tracer
    if _tracer is None:
        return setup_tracing()
    return _tracer
