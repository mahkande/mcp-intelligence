#!/usr/bin/env node

/**
 * Check Python Installation
 * 
 * Verifies that Python 3.8+ is installed before proceeding with package installation.
 */

const { spawnSync } = require('child_process');

function checkPython() {
  const pythonCommands = ['python3', 'python', 'py'];
  
  for (const cmd of pythonCommands) {
    try {
      const result = spawnSync(cmd, ['--version'], {
        encoding: 'utf-8',
        stdio: ['pipe', 'pipe', 'pipe']
      });
      
      if (result.status === 0) {
        const versionOutput = result.stdout || result.stderr || '';
        const versionMatch = versionOutput.match(/Python (\d+)\.(\d+)/);
        
        if (versionMatch) {
          const major = parseInt(versionMatch[1]);
          const minor = parseInt(versionMatch[2]);
          
          if (major === 3 && minor >= 8) {
            console.log(`✓ Found ${versionOutput.trim()}`);
            return true;
          } else if (major > 3) {
            console.log(`✓ Found ${versionOutput.trim()}`);
            return true;
          } else {
            console.warn(`⚠ Found ${versionOutput.trim()} but Python 3.8+ is required`);
          }
        }
      }
    } catch (e) {
      continue;
    }
  }
  
  console.error('\n❌ Python 3.8+ is required but not found.');
  console.error('\nPlease install Python:');
  console.error('  • Windows/Mac: https://www.python.org/downloads/');
  console.error('  • Linux: sudo apt install python3 python3-pip');
  console.error('\nAfter installing Python, run: npm install pylance-mcp-server');
  
  process.exit(1);
}

// Only check if not in CI environment
if (!process.env.CI && !process.env.SKIP_PYTHON_CHECK) {
  checkPython();
}
